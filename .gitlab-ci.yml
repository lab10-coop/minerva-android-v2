image: code.lab10.io:4567/graz/10-minerva/minerva-android-v2:builder

variables:
  ANDROID_BUILD_TOOLS: 28.0.2
  ANDROID_HOME: /android-sdk-linux

before_script:
  - cp ./gradle/wrapper/gradle-wrapper.properties.ci ./gradle/wrapper/gradle-wrapper.properties
  - yes | /android-sdk-linux/tools/bin/sdkmanager "platform-tools" >/dev/null 2>&1 || true
  - yes | /android-sdk-linux/tools/bin/sdkmanager "build-tools;$ANDROID_BUILD_TOOLS" >/dev/null 2>&1 || true
  - yes | /android-sdk-linux/tools/bin/sdkmanager --licenses >/dev/null 2>&1 || true

stages:
#  - preparation
  - validation
  - distribution
  - deploy

#restoreKeystoreFile:
#  stage: preparation
#  only:
#    refs:
#      - develop #master and production
#  script:
#    - echo "$KEY_STORE_FILE" > keyStoreMinerva.jks.b64
#    - base64 -d -i keyStoreMinerva.jks.b64 > MinervaApp/keyStoreMinerva.jks

#  env:
#    KEY_STORE_FILE: ${{ secrets.KEY_STORE_FILE }}

#validateBranch:
#  stage: validation
#  except:
#    refs:
#      - master
#  script:
#    - ./gradlew test
#
#validateLint:
#  stage: validation
#  except:
#    refs:
#      - master
#  script:
#    - ./gradlew lint

distributeStagingBuild:
  stage: distribution
  only:
    refs:
      - develop
#      - master

  script:
    - echo "$KEY_STORE_FILE" > keyStoreMinerva.jks.b64
    - base64 -d -i keyStoreMinerva.jks.b64 > MinervaApp/keyStoreMinerva.jks
    - ./gradlew build
    - . /etc/profile.d/rvm.sh
    - ./BuildScripts/build_fastlane.sh
    - fastlane firebaseStaging
    - 'curl --silent --show-error --request PUT --header "PRIVATE-TOKEN: $API_TOKEN" "https://code.lab10.io/api/v4/projects/166/variables/VERSION_CODE_STAGING" --form "value=$(($VERSION_CODE_STAGING + 1))"'

  artifacts:
    paths:
      - ./MinervaApp/build/outputs/apk/staging

#distributeProductionBuild:
#  stage: distribution
#  only:
#    refs:
#      - develop
##      - master
#
#  script:
#    - ./gradlew build
#    - . /etc/profile.d/rvm.sh
#    - ./BuildScripts/build_fastlane.sh
#    - fastlane firebaseProduction
#    - 'curl --silent --show-error --request PUT --header "PRIVATE-TOKEN: $API_TOKEN" "https://code.lab10.io/api/v4/projects/166/variables/VERSION_CODE_STAGING" --form "value=$(($VERSION_CODE_STAGING + 1))"'
#
#  artifacts:
#    paths:
#      - ./MinervaApp/build/outputs/apk/production

deployProductionBuild:
  stage: distribution
  only:
    refs:
      - production

  script:
    - ./gradlew build
    - . /etc/profile.d/rvm.sh
    - ./BuildScripts/build_fastlane.sh
    - fastlane firebaseProduction
    - 'curl --silent --show-error --request PUT --header "PRIVATE-TOKEN: $API_TOKEN" "https://code.lab10.io/api/v4/projects/166/variables/VERSION_CODE_STAGING" --form "value=$(($VERSION_CODE_STAGING + 1))"'

  artifacts:
    paths:
      - ./MinervaApp/build/outputs/apk/production

#Uncomment when production app is ready, to upload every new version automatically. Check if the Google Play credential file is needed at this stage ?
#productionBetaReleaseBuild:
#  stage: diploy
#  only:
#    refs:
#      - production
#
#  script:
#    - ./gradlew build
#    - . /etc/profile.d/rvm.sh
#    - ./BuildScripts/build_fastlane.sh
#    - fastlane productionRelease
#    - 'curl --silent --show-error --request PUT --header "PRIVATE-TOKEN: $API_TOKEN" "https://code.lab10.io/api/v4/projects/166/variables/VERSION_CODE_STAGING" --form "value=$(($VERSION_CODE_STAGING + 1))"'
#
#  artifacts:
#    paths:
#      - ./MinervaApp/build/outputs/apk/production